<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý đơn hàng</title>
  <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../css/admin.css">
  <link rel="stylesheet" href="../css/index.css">
 
  <script>
    // Kiểm tra trạng thái đăng nhập
    if (localStorage.getItem("AdminLogged") !== "quanly1") {
        // Chưa đăng nhập => chuyển về trang login
        window.location.href = "../sites/login_admin.html";
    }

  </script>
  <style>
    .table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
  </style>
</head>
<body class="bg-light">
   <nav class="navbar navbar-expand-lg navbar-dark background-blue fixed-top shadow">
    <div class="container-fluid">

      <!-- Logo -->
      <a href="#" class="navbar-brand d-flex align-items-center">
        <img src="../asset/logo.png" alt="Logo" class="me-2" style="height: 80px;">
      </a>

      <!-- Nút thu gọn -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
        aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Menu chính -->
      <div class="collapse navbar-collapse justify-content-end" id="mainNav">
        <ul class="navbar-nav align-items-center text-center mb-2 mb-md-0" id="admin-navbar">
         <li class="nav-item mx-1"><a href="admin_user_manage.html" class="btn btn-outline-dark border-dark">Quản lý người dùng</a></li>
          <li class="nav-item mx-1"><a href="admin_add_items.html" class="btn btn-outline-dark border-dark">Quản lý danh mục sản phẩm</a></li>
          <li class="nav-item mx-1"><a href="admin_add_bill.html" class="btn btn-outline-dark border-dark">Quản lý nhập hàng</a></li>
          <li class="nav-item mx-1"><a href="admin_price_manage.html" class="btn btn-outline-dark border-dark">Quản lý giá bán</a></li>
          <li class="nav-item mx-1"><a href="admin_order_manage.html" class="btn btn-outline-dark border-dark">Quản lý đơn đặt hàng</a></li>
          <li class="nav-item mx-1"><a href="admin_storage_manage.html" class="btn btn-outline-dark border-dark">Quản lý tồn kho</a></li>
        </ul>
        <!-- JS sẽ thêm phần admin vào đây -->
      </div>

      </div>
    </nav>
       
  
   <div style="height: 90px"></div>
 <div class="container mt-4 mb-5">
    <h2 class="text-center mb-4 fw-bold">Quản lý đơn hàng</h2>

    <!-- Bộ lọc -->
    <div class="card p-3 mb-4 shadow-sm">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="fromDate" class="form-label">Từ ngày</label>
          <input type="date" id="fromDate" class="form-control">
        </div>
        <div class="col-md-4">
          <label for="toDate" class="form-label">Đến ngày</label>
          <input type="date" id="toDate" class="form-control">
        </div>
        <div class="col-md-4">
          <label for="statusFilter" class="form-label">Tình trạng đơn hàng</label>
          <select id="statusFilter" class="form-select">
            <option value="">Tất cả</option>
            <option value="mới đặt">Mới đặt</option>
            <option value="đã xử lý">Đã xử lý</option>
            <option value="đã giao">Đã giao</option>
            <option value="hủy">Hủy</option>
          </select>
        </div>
      </div>
      <div class="text-end mt-3">
        <button id="filterBtn" class="btn btn-primary">Lọc</button>
        <button id="resetBtn" class="btn btn-secondary">Hiển thị tất cả</button>
      </div>
    </div>

    <!-- Bảng hiển thị đơn hàng -->
    <div class="card shadow-sm">
     <div class="card-body table-responsive">
  <table class="table table-bordered table-hover text-nowrap">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>Tên khách hàng</th>
              <th>Ngày đặt</th>
              <th>Tình trạng</th>
              <th>Tổng tiền</th>
              <th>Chi tiết</th>
            </tr>
          </thead>
          <tbody id="orderTableBody">
            <!-- Dữ liệu thêm bằng JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
<div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Chi tiết đơn hàng</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <p><strong>Mã đơn hàng:</strong> <span id="modalOrderId"></span></p>
        <p><strong>Khách hàng:</strong> <span id="modalCustomer"></span></p>
        <p><strong>Ngày đặt:</strong> <span id="modalDate"></span></p>

        <!-- Chỉnh sửa tình trạng -->
        <div class="mb-3">
          <label for="modalStatusSelect" class="form-label"><strong>Tình trạng:</strong></label>
          <select id="modalStatusSelect" class="form-select">
            <option value="Mới đặt">Mới đặt</option>
            <option value="Đã xử lý">Đã xử lý</option>
            <option value="Đã giao">Đã giao</option>
            <option value="Hủy">Hủy</option>
          </select>
        </div>

        <p><strong>Tổng tiền:</strong> <span id="modalTotal"></span></p>
        <hr>
        <p><strong>Sản phẩm:</strong></p>
        <ul id="modalItems" class="list-group list-group-flush"></ul>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="saveStatusBtn">Lưu thay đổi</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>


 <script src="../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const defaultOrders = [
   { id: "DH001", customer: "Nguyễn Văn A", date: "2025-11-01", total: 12500000, status: "Mới đặt", items: ["Tivi Samsung 55 inch", "Loa Bluetooth Sony", "Điều khiển thông minh"] },
  { id: "DH002", customer: "Trần Thị B", date: "2025-11-02", total: 4800000, status: "Đã xử lý", items: ["Nồi chiên không dầu Philips", "Máy xay sinh tố Sunhouse"] },
  { id: "DH003", customer: "Lê Văn C", date: "2025-11-03", total: 8900000, status: "Đã giao", items: ["Máy giặt LG Inverter 8kg"] },
  { id: "DH004", customer: "Phạm Thị D", date: "2025-11-04", total: 3200000, status: "Hủy", items: ["Bàn ủi hơi nước", "Máy sấy tóc Panasonic"] },
  { id: "DH005", customer: "Nguyễn Văn E", date: "2025-11-05", total: 15900000, status: "Mới đặt", items: ["Tủ lạnh Toshiba 2 cánh", "Bếp hồng ngoại Sunhouse"] },
  { id: "DH006", customer: "Trần Văn F", date: "2025-11-05", total: 7400000, status: "Đã xử lý", items: ["Máy lọc không khí Sharp", "Quạt điều hòa Kangaroo"] },
  { id: "DH007", customer: "Phan Thị G", date: "2025-11-06", total: 2100000, status: "Đã giao", items: ["Bàn phím cơ Logitech", "Chuột không dây Logitech"] },
  { id: "DH008", customer: "Đỗ Văn H", date: "2025-11-06", total: 3100000, status: "Đã giao", items: ["Camera an ninh Xiaomi", "Ổ cắm thông minh TP-Link"] },
  { id: "DH009", customer: "Nguyễn Thị I", date: "2025-11-07", total: 4500000, status: "Hủy", items: ["Máy hút bụi Philips", "Bàn ủi hơi nước đứng"] },
  { id: "DH010", customer: "Lê Văn K", date: "2025-11-08", total: 9800000, status: "Đã xử lý", items: ["Lò vi sóng Sharp", "Máy pha cà phê Delonghi"] }
  ];

  let orders = JSON.parse(localStorage.getItem("orders")) || defaultOrders;
  const orderTableBody = document.getElementById("orderTableBody");

  function getStatusColor(status) {
    switch (status) {
      case "Mới đặt": return "bg-primary";
      case "Đã xử lý": return "bg-warning text-dark";
      case "Đã giao": return "bg-success";
      case "Hủy": return "bg-danger";
      default: return "bg-secondary";
    }
  }

  // --- Render bảng ---
  function renderOrders(list = orders) {
    orderTableBody.innerHTML = "";
    list.forEach((order, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${order.id}</td>
        <td>${order.customer}</td>
        <td>${order.date}</td>
        <td><span class="badge ${getStatusColor(order.status)}">${order.status}</span></td>
        <td>${order.total.toLocaleString("vi-VN")} ₫</td>
        <td>
          <button class="btn btn-sm btn-info text-white" onclick="viewOrder(${index})">Xem</button>
        </td>
      `;
      orderTableBody.appendChild(tr);
    });
    localStorage.setItem("orders", JSON.stringify(orders));
    applyPagination(); // gọi phân trang
  }

  // --- Lọc đơn hàng ---
  document.getElementById("filterBtn").addEventListener("click", () => {
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;
    const status = document.getElementById("statusFilter").value;

    if (!from && !to && !status) return renderOrders();

    let filtered = orders;
    if (from && to) filtered = filtered.filter(o => o.date >= from && o.date <= to);
    if (status) filtered = filtered.filter(o => o.status.toLowerCase() === status.toLowerCase());

    renderOrders(filtered);
  });

  // --- Hiển thị tất cả ---
  document.getElementById("resetBtn").addEventListener("click", () => {
    document.getElementById("fromDate").value = "";
    document.getElementById("toDate").value = "";
    document.getElementById("statusFilter").value = "";
    renderOrders();
  });

  // --- Modal xem đơn ---
  let currentOrderIndex = null;

  window.viewOrder = function (index) {
    currentOrderIndex = index;
    const order = orders[index];
    document.getElementById("modalOrderId").innerText = order.id;
    document.getElementById("modalCustomer").innerText = order.customer;
    document.getElementById("modalDate").innerText = order.date;
    document.getElementById("modalTotal").innerText = `${order.total.toLocaleString("vi-VN")} ₫`;

    const select = document.getElementById("modalStatusSelect");
    select.value = order.status;

    const itemsList = document.getElementById("modalItems");
    itemsList.innerHTML = "";
    order.items.forEach(item => {
      const li = document.createElement("li");
      li.className = "list-group-item";
      li.textContent = item;
      itemsList.appendChild(li);
    });

    const modal = new bootstrap.Modal(document.getElementById("orderModal"));
    modal.show();
  };

  // --- Lưu tình trạng ---
  document.getElementById("saveStatusBtn").addEventListener("click", () => {
    if (currentOrderIndex === null) return;
    const newStatus = document.getElementById("modalStatusSelect").value;

    orders[currentOrderIndex].status = newStatus;
    localStorage.setItem("orders", JSON.stringify(orders));
    renderOrders();

    const modal = bootstrap.Modal.getInstance(document.getElementById("orderModal"));
    modal.hide();
  });

  // --- Phân trang theo form bạn gửi ---
  const rowsPerPage = 8;
  let currentPage = 1;

  function applyPagination() {
    const table = document.querySelector("table");
    const rows = Array.from(table.querySelectorAll("tbody tr"));

    // Tạo vùng phân trang nếu chưa có
    let paginationDiv = document.getElementById("pagination");
    if (!paginationDiv) {
      paginationDiv = document.createElement("div");
      paginationDiv.id = "pagination";
      paginationDiv.className = "d-flex justify-content-center align-items-center mt-3 gap-2";
      table.insertAdjacentElement("afterend", paginationDiv);
    }

    // Ẩn hết rồi hiển thị theo trang
    rows.forEach(row => row.style.display = "none");

    const totalPages = Math.ceil(rows.length / rowsPerPage);
    currentPage = Math.min(currentPage, totalPages) || 1;

    const start = (currentPage - 1) * rowsPerPage;
    const end = currentPage * rowsPerPage;
    rows.slice(start, end).forEach(row => row.style.display = "");

    renderPagination(totalPages);
  }

  function renderPagination(totalPages) {
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    const prev = document.createElement("button");
    prev.textContent = "« Trước";
    prev.className = "btn btn-outline-primary btn-sm";
    prev.disabled = currentPage === 1;
    prev.onclick = () => { currentPage--; applyPagination(); };

    const next = document.createElement("button");
    next.textContent = "Sau »";
    next.className = "btn btn-outline-primary btn-sm";
    next.disabled = currentPage === totalPages;
    next.onclick = () => { currentPage++; applyPagination(); };

    const pageInfo = document.createElement("span");
    pageInfo.textContent = `Trang ${currentPage} / ${totalPages || 1}`;
    pageInfo.className = "mx-2";

    pagination.append(prev, pageInfo, next);
  }

  // --- Hiển thị mặc định ---
  renderOrders();
});

// --- Navbar hiển thị admin ---
document.addEventListener("DOMContentLoaded", () => {
  const nav = document.getElementById("admin-navbar");
  const tenAdmin = localStorage.getItem("AdminLogged") || "Admin";

  const nameItem = document.createElement("li");
  nameItem.className = "nav-item mx-1 fw-bold text-dark";
  nameItem.innerHTML = `
    <div class="d-flex align-items-center">
      <img src="../asset/user_icon.png" alt="User" style="height:40px; width:40px; border-radius:50%; border:2px solid white; margin-right:8px;">
      <span>${tenAdmin}</span>
    </div>
  `;

  const logoutBtn = document.createElement("button");
  logoutBtn.className = "btn background-blue border-dark btn-sm fw-bold ms-2";
  logoutBtn.textContent = "Đăng xuất";
  logoutBtn.onclick = () => {
    alert("Đã đăng xuất!");
    localStorage.removeItem("AdminLogged");
    location.reload();
  };

  const logoutItem = document.createElement("li");
  logoutItem.className = "nav-item mx-1";
  logoutItem.appendChild(logoutBtn);

  nav.appendChild(nameItem);
  nav.appendChild(logoutItem);
});
</script>

</body>
</html>
